---
// Generated by Copilot
import Layout from '@/components/Layout.astro';
import Sidebar from '@/components/Sidebar.astro';
import SearchBar from '@/components/SearchBar';
import ThemeToggle from '@/components/ThemeToggle';
import SchemaTabsContainer from '@/components/SchemaTabsContainer';
import CopyableId from '@/components/CopyableId';
import { normalizeBasePath } from '@/lib/utils';

// Get the base path with trailing slash
const base = normalizeBasePath(import.meta.env.BASE_URL || '/');

// Load all data once
let schemaData, configData, graphData;
try {
  schemaData = await import('../../../public/data/schemas.json');
  configData = await import('../../../public/data/configs.json');
  graphData = await import('../../../public/data/graph.json');
} catch (error) {
  console.warn('Data files not found. Run npm run build:data first.');
  schemaData = { schemas: [] };
  configData = { configs: [] };
  graphData = { nodes: [], edges: [] };
}

// Generate static paths for all schemas at build time
export async function getStaticPaths() {
  let data;
  try {
    data = await import('../../../public/data/schemas.json');
    console.log(`[getStaticPaths] Loaded ${data.schemas?.length || 0} schemas`);
  } catch (error) {
    console.error('[getStaticPaths] Schema data not found. Run npm run build:data first.', error);
    return [];
  }

  const paths = data.schemas.map((schema: any) => ({
    params: { path: `${schema.path}/v${schema.version}` },
    props: { schema },
  }));

  console.log(`[getStaticPaths] Generated ${paths.length} paths`);
  console.log(
    `[getStaticPaths] Sample paths:`,
    paths.slice(0, 3).map((p: any) => p.params.path)
  );

  return paths;
}

// Get the path from URL (e.g., "infra/jobnik/worker/v1")
const { path } = Astro.params;
const { schema: propsSchema } = Astro.props as { schema?: any };

console.log(`[Page] Rendering path: ${path}`);
console.log(`[Page] Props schema:`, propsSchema ? `${propsSchema.path}/v${propsSchema.version}` : 'undefined');

// Determine which schema to use
let schema = propsSchema;

// If we don't have the schema from props (dev mode fallback), look it up
if (!schema) {
  // Parse path to find schema
  const pathSegments = (path as string)?.split('/') || [];
  if (pathSegments.length < 2) {
    return Astro.redirect(base);
  }

  // Get version and schema path
  const version = pathSegments[pathSegments.length - 1]; // e.g., "v1"
  const schemaPath = pathSegments.slice(0, -1).join('/'); // e.g., "infra/jobnik/worker"

  // Find the specific schema
  schema = schemaData.schemas.find((s: any) => s.path === schemaPath && `v${s.version}` === version);

  if (!schema) {
    console.warn(`Schema not found: ${schemaPath} ${version}`);
    return Astro.redirect(base);
  }
}

// Find configs for this schema
const configs = configData.configs.find((c: any) => c.schemaId === schema.id);

// Build breadcrumbs - include full path segments
// Generated by Copilot
const pathSegments = schema.path.split('/');
// Remove category from path segments if it's the first segment
const filteredSegments = pathSegments[0] === schema.category ? pathSegments.slice(1) : pathSegments;

const breadcrumbs = [
  { label: 'Home', href: base },
  { label: schema.category, href: `${base}category/${schema.category}` },
  ...filteredSegments.map((segment: string) => ({
    label: segment,
    href: '', // These are just path segments, not clickable
  })),
  { label: `v${schema.version}`, href: '' },
];
---

<Layout title={schema.title}>
  <!-- Header -->
  <header class="border-b sticky top-0 z-50 bg-background">
    <div class="flex items-center justify-between px-4 py-3">
      <a href={base} class="text-xl font-bold hover:underline"> MapColonies Schemas </a>
      <div class="flex items-center gap-4">
        <SearchBar client:load />
        <ThemeToggle client:load />
      </div>
    </div>
  </header>

  <!-- Main content with sidebar -->
  <div class="flex h-[calc(100vh-57px)]">
    <Sidebar />
    <main class="flex-1 p-6 overflow-y-auto">
      <div class="container mx-auto max-w-6xl">
        <!-- Breadcrumb -->
        <nav class="mb-4 text-sm flex items-center gap-2 text-muted-foreground">
          {
            breadcrumbs.map((crumb: any, idx: number) => (
              <>
                {idx > 0 && <span>/</span>}
                {crumb.href ? (
                  <a href={crumb.href} class="hover:text-foreground hover:underline">
                    {crumb.label}
                  </a>
                ) : (
                  <span class="text-foreground font-medium">{crumb.label}</span>
                )}
              </>
            ))
          }
        </nav>

        <!-- Header -->
        <div class="mb-6">
          <h1 class="text-3xl font-bold mb-2">{schema.title}</h1>
          <p class="text-muted-foreground mb-3">{schema.description}</p>
          <div class="flex items-center gap-2">
            <CopyableId id={schema.id} client:load />
            <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded font-medium">
              {schema.category}
            </span>
          </div>
        </div>

        <!-- Tabs -->
        <SchemaTabsContainer schema={schema} graphData={graphData} configs={configs} allSchemas={schemaData.schemas} client:load />
      </div>
    </main>
  </div>
</Layout>
