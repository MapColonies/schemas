---
// Generated by Copilot
import Layout from '@/components/Layout.astro';
import Sidebar from '@/components/Sidebar.astro';
import ThemeToggle from '@/components/ThemeToggle';
import GraphWithSearch from '@/components/GraphWithSearch';
import { normalizeBasePath } from '@/lib/utils';

// Get the base path with trailing slash
const base = normalizeBasePath(import.meta.env.BASE_URL || '/');

// Load graph data at build time
let graphData;
try {
  graphData = await import('../../public/data/graph.json');
} catch (error) {
  console.warn('Graph data not found. Run npm run build:data first.');
  graphData = { nodes: [], edges: [] };
}

const totalNodes = graphData.nodes.length;
const totalEdges = graphData.edges.length;
---

<Layout title="Schema Dependency Graph">
  <!-- Header -->
  <header class="border-b sticky top-0 z-50 bg-background">
    <div class="flex items-center justify-between px-4 py-3">
      <a href={base} class="text-xl font-bold hover:underline"> MapColonies Schemas </a>
      <div class="flex items-center gap-4">
        <ThemeToggle client:load />
      </div>
    </div>
  </header>

  <!-- Main content with sidebar -->
  <div class="flex h-[calc(100vh-57px)]">
    <Sidebar />
    <main class="flex-1 p-6 overflow-y-auto">
      <div class="container mx-auto max-w-6xl">
        <h1 class="text-3xl font-bold mb-4">Schema Dependency Graph</h1>
        <p class="text-muted-foreground mb-6">Interactive visualization of all schema dependencies</p>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="border rounded-lg p-4 bg-card">
            <p class="text-sm text-muted-foreground mb-1">Total Schemas</p>
            <p class="text-2xl font-bold">{totalNodes}</p>
          </div>
          <div class="border rounded-lg p-4 bg-card">
            <p class="text-sm text-muted-foreground mb-1">Dependencies</p>
            <p class="text-2xl font-bold">{totalEdges}</p>
          </div>
          <div class="border rounded-lg p-4 bg-card">
            <p class="text-sm text-muted-foreground mb-1">Avg. Connections</p>
            <p class="text-2xl font-bold">
              {totalNodes > 0 ? ((totalEdges / totalNodes) * 2).toFixed(1) : 0}
            </p>
          </div>
          <div class="border rounded-lg p-4 bg-card">
            <p class="text-sm text-muted-foreground mb-1">Categories</p>
            <p class="text-2xl font-bold">
              {[...new Set(graphData.nodes.map((n: any) => n.category))].length}
            </p>
          </div>
        </div>

        <!-- Force-directed graph visualization -->
        <div class="border rounded-lg bg-card overflow-hidden" style="height: 800px;">
          <GraphWithSearch data={graphData} client:only="react" />
        </div>
      </div>

      <!-- Top Schemas -->
      <div class="mt-8">
        <h2 class="text-2xl font-bold mb-4">Most Connected Schemas</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {
            graphData.nodes
              .sort((a: any, b: any) => b.degree - a.degree)
              .slice(0, 10)
              .map((node: any) => (
                <div class="border rounded-lg p-4 bg-card hover:shadow-md transition-shadow">
                  <a href={`${base}schema/${node.path}/v${node.version}`} class="font-semibold hover:underline block mb-1">
                    {node.label}
                  </a>
                  <p class="text-sm text-muted-foreground mb-2">
                    {node.category} â€¢ v{node.version}
                  </p>
                  <div class="flex items-center gap-2 text-sm">
                    <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">{node.degree} connections</span>
                  </div>
                </div>
              ))
          }
        </div>
      </div>
    </main>
  </div>
</Layout>
