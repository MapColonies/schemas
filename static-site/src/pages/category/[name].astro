---
// Generated by Copilot
import Layout from '@/components/Layout.astro';
import Sidebar from '@/components/Sidebar.astro';
import SearchBar from '@/components/SearchBar';
import ThemeToggle from '@/components/ThemeToggle';
import { normalizeBasePath } from '@/lib/utils';

// Get the base path with trailing slash
const base = normalizeBasePath(import.meta.env.BASE_URL || '/');

// Load schema data once
let schemaData;
try {
  schemaData = await import('../../../public/data/schemas.json');
} catch (error) {
  console.warn('Schema data not found. Run npm run build:data first.');
  schemaData = { schemas: [], categories: [] };
}

// Generate static paths for all categories at build time
export async function getStaticPaths() {
  let data;
  try {
    data = await import('../../../public/data/schemas.json');
  } catch (error) {
    console.warn('Schema data not found. Run npm run build:data first.');
    return [];
  }

  return data.categories.map((category: any) => ({
    params: { name: category.name },
  }));
}

// Get the category from URL
const { name } = Astro.params;

// Filter schemas by category
const categorySchemas = schemaData.schemas.filter((s: any) => s.category === name);
const category = schemaData.categories.find((c: any) => c.name === name);

// Redirect if category not found
if (!category) {
  return Astro.redirect(base);
}

// Group schemas by path (base name without version)
const schemaGroups = categorySchemas.reduce(
  (acc: Record<string, any[]>, schema: any) => {
    const baseName = schema.path;
    if (!acc[baseName]) acc[baseName] = [];
    acc[baseName].push(schema);
    return acc;
  },
  {} as Record<string, any[]>
);

// Sort versions within each group (highest first)
Object.values(schemaGroups).forEach((group: any[]) => {
  group.sort((a, b) => b.version - a.version);
});
---

<Layout title={`${name} Schemas`}>
  <!-- Header -->
  <header class="border-b sticky top-0 z-50 bg-background">
    <div class="flex items-center justify-between px-4 py-3">
      <a href={base} class="text-xl font-bold hover:underline"> MapColonies Schemas </a>
      <div class="flex items-center gap-4">
        <SearchBar client:load />
        <ThemeToggle client:load />
      </div>
    </div>
  </header>

  <!-- Main content with sidebar -->
  <div class="flex h-[calc(100vh-57px)]">
    <Sidebar />
    <main class="flex-1 p-6 overflow-y-auto">
      <div class="container mx-auto max-w-6xl">
        <!-- Breadcrumb -->
        <nav class="mb-4 text-sm flex items-center gap-2 text-muted-foreground">
          <a href={base} class="hover:text-foreground hover:underline"> Home </a>
          <span>/</span>
          <span class="text-foreground font-medium capitalize">{name}</span>
        </nav>

        <!-- Header -->
        <div class="mb-6">
          <h1 class="text-3xl font-bold mb-2 capitalize">{name} Schemas</h1>
          <p class="text-muted-foreground mb-3">
            {Object.keys(schemaGroups).length}
            {Object.keys(schemaGroups).length === 1 ? 'schema' : 'schemas'}
            ({categorySchemas.length} total versions) in this category
          </p>
        </div>

        <!-- Schema List -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {
            Object.entries(schemaGroups).map(([path, versions]: [string, any[]]) => {
              const latestSchema = versions[0];
              // Format the path as a readable title (e.g., "infra/opala/manager" -> "Infra / Opala / Manager")
              const pathTitle = path
                .split('/')
                .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
                .join(' / ');

              return (
                <div class="border rounded-lg p-5 bg-card hover:shadow-lg transition-shadow">
                  {/* Schema path as title */}
                  <h3 class="font-bold text-lg mb-3">{pathTitle}</h3>

                  {/* Versions section */}
                  <div class="mb-4">
                    <div class="text-xs font-semibold text-muted-foreground mb-2">VERSIONS ({versions.length})</div>
                    <div class="space-y-2">
                      {versions.map((schema: any) => (
                        <a
                          href={`${base}schema/${schema.path}/v${schema.version}`}
                          class="flex items-start justify-between p-3 rounded border hover:bg-accent transition-colors group"
                        >
                          <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                              <span class="font-mono text-sm font-semibold">v{schema.version}</span>
                              {schema.title && <span class="text-xs text-muted-foreground truncate">{schema.title}</span>}
                            </div>
                            <div class="flex items-center gap-2 flex-wrap">
                              {schema.hasConfig && (
                                <span class="text-xs bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 px-2 py-0.5 rounded">
                                  Has configs
                                </span>
                              )}
                              {schema.references && schema.references.length > 0 && (
                                <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded">
                                  {schema.references.length} dep{schema.references.length !== 1 ? 's' : ''}
                                </span>
                              )}
                            </div>
                          </div>
                          <svg
                            class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0 mt-0.5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                          >
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                          </svg>
                        </a>
                      ))}
                    </div>
                  </div>

                  {/* Summary at bottom */}
                  <div class="pt-3 border-t text-xs text-muted-foreground">
                    {versions.length} version{versions.length !== 1 ? 's' : ''} â€¢ Latest: v{latestSchema.version}
                  </div>
                </div>
              );
            })
          }
        </div>

        {
          categorySchemas.length === 0 && (
            <div class="border rounded-lg p-12 text-center text-muted-foreground">No schemas found in this category.</div>
          )
        }
      </div>
    </main>
  </div>
</Layout>
