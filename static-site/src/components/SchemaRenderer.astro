---
// Generated by Copilot
import { normalizeBasePath } from '@/lib/utils';

interface Props {
  schema: any;
}

const { schema } = Astro.props;

// Ensure base ends with slash
const normalizedBase = normalizeBasePath(import.meta.env.BASE_URL || '/');

// Helper function to extract properties from schema (handling allOf)
const extractProperties = (schemaObj: any): { properties: any; required: string[] } => {
  let allProperties: any = {};
  let allRequired: string[] = [];

  // Handle direct properties
  if (schemaObj.properties) {
    allProperties = { ...allProperties, ...schemaObj.properties };
  }
  if (schemaObj.required) {
    allRequired = [...allRequired, ...schemaObj.required];
  }

  // Handle allOf (merge properties from all schemas)
  if (schemaObj.allOf) {
    schemaObj.allOf.forEach((subSchema: any) => {
      if (subSchema.properties) {
        allProperties = { ...allProperties, ...subSchema.properties };
      }
      if (subSchema.required) {
        allRequired = [...allRequired, ...subSchema.required];
      }
    });
  }

  return { properties: allProperties, required: allRequired };
};

const { properties, required } = extractProperties(schema);
const definitions = schema.definitions || {};

// Helper to format type information
const formatType = (prop: any): string => {
  if (prop.type) {
    return Array.isArray(prop.type) ? prop.type.join(' | ') : prop.type;
  }
  if (prop.enum) {
    return 'enum';
  }
  if (prop.oneOf || prop.anyOf) {
    return 'union';
  }
  return 'object';
};

// Helper to get reference link
const getRefLink = (ref: string): string => {
  if (ref.startsWith('https://mapcolonies.com/')) {
    return ref.replace('https://mapcolonies.com/', '');
  }
  return ref;
};
---

<div class="space-y-6">
  {schema.description && <p class="text-muted-foreground border-l-4 border-blue-500 pl-4 py-2 my-4">{schema.description}</p>}

  {/* Main Properties Section */}
  {
    Object.keys(properties).length > 0 ? (
      <div>
        <h3 class="text-lg font-semibold mb-3">Properties</h3>
        <div class="border rounded-lg overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-100 dark:bg-gray-800">
              <tr>
                <th class="px-4 py-2 text-left text-sm font-semibold">Property</th>
                <th class="px-4 py-2 text-left text-sm font-semibold">Type</th>
                <th class="px-4 py-2 text-left text-sm font-semibold">Required</th>
                <th class="px-4 py-2 text-left text-sm font-semibold">Description</th>
              </tr>
            </thead>
            <tbody>
              {Object.entries(properties).map(([name, prop]: [string, any]) => (
                <tr class="border-t hover:bg-gray-50 dark:hover:bg-gray-800/50">
                  <td class="px-4 py-3 font-mono text-sm font-medium">{name}</td>
                  <td class="px-4 py-3">
                    {prop.type && <code class="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded text-xs">{formatType(prop)}</code>}
                    {prop.$ref &&
                      (prop.$ref.startsWith('https://') ? (
                        <a href={`${normalizedBase}schema/${getRefLink(prop.$ref)}`} class="text-blue-600 hover:underline text-sm">
                          {prop.$ref.split('/').pop()}
                        </a>
                      ) : (
                        <a href={`#def-${prop.$ref.replace('#/definitions/', '')}`} class="text-blue-600 hover:underline text-sm">
                          {prop.$ref.split('/').pop()}
                        </a>
                      ))}
                    {!prop.type && !prop.$ref && <code class="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded text-xs">{formatType(prop)}</code>}
                  </td>
                  <td class="px-4 py-3 text-center">
                    {required.includes(name) ? (
                      <span class="text-green-600 font-semibold" title="Required">
                        ✓
                      </span>
                    ) : (
                      <span class="text-gray-400" title="Optional">
                        -
                      </span>
                    )}
                  </td>
                  <td class="px-4 py-3 text-sm text-muted-foreground">
                    {prop.description || '-'}
                    {prop.default !== undefined && (
                      <div class="mt-1 text-xs">
                        <span class="font-medium">Default:</span>
                        <code class="bg-gray-100 dark:bg-gray-800 px-1 rounded ml-1">{JSON.stringify(prop.default)}</code>
                      </div>
                    )}
                    {prop.enum && (
                      <div class="mt-1 text-xs">
                        <span class="font-medium">Values:</span>
                        <code class="bg-gray-100 dark:bg-gray-800 px-1 rounded ml-1">{prop.enum.join(', ')}</code>
                      </div>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    ) : (
      <div class="text-center py-8 text-muted-foreground border rounded-lg">
        No direct properties defined. This schema may use references or definitions.
      </div>
    )
  }

  {/* Definitions Section */}
  {
    Object.keys(definitions).length > 0 && (
      <div>
        <h3 class="text-lg font-semibold mb-3">Definitions</h3>
        <div class="space-y-4">
          {Object.entries(definitions).map(([defName, defSchema]: [string, any]) => {
            const defProps = defSchema.properties || {};
            const defRequired = defSchema.required || [];

            return (
              <div id={`def-${defName}`} class="border rounded-lg p-4 scroll-mt-20">
                <h4 class="font-semibold text-md mb-2 font-mono">{defName}</h4>
                {defSchema.description && <p class="text-sm text-muted-foreground mb-3">{defSchema.description}</p>}
                {Object.keys(defProps).length > 0 ? (
                  <div class="border rounded-lg overflow-hidden">
                    <table class="w-full text-sm">
                      <thead class="bg-gray-50 dark:bg-gray-800/50">
                        <tr>
                          <th class="px-3 py-2 text-left text-xs font-semibold">Property</th>
                          <th class="px-3 py-2 text-left text-xs font-semibold">Type</th>
                          <th class="px-3 py-2 text-left text-xs font-semibold">Required</th>
                          <th class="px-3 py-2 text-left text-xs font-semibold">Description</th>
                        </tr>
                      </thead>
                      <tbody>
                        {Object.entries(defProps).map(([propName, prop]: [string, any]) => (
                          <tr class="border-t hover:bg-gray-50 dark:hover:bg-gray-800/50">
                            <td class="px-3 py-2 font-mono text-xs">{propName}</td>
                            <td class="px-3 py-2">
                              <code class="bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-xs">{formatType(prop)}</code>
                            </td>
                            <td class="px-3 py-2 text-center">
                              {defRequired.includes(propName) ? (
                                <span class="text-green-600 font-semibold">✓</span>
                              ) : (
                                <span class="text-gray-400">-</span>
                              )}
                            </td>
                            <td class="px-3 py-2 text-xs text-muted-foreground">
                              {prop.description || '-'}
                              {prop.default !== undefined && (
                                <div class="mt-0.5">
                                  <span class="font-medium">Default:</span>
                                  <code class="bg-gray-100 dark:bg-gray-800 px-1 rounded ml-1">{JSON.stringify(prop.default)}</code>
                                </div>
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <p class="text-sm text-muted-foreground italic">No properties defined for this definition.</p>
                )}
              </div>
            );
          })}
        </div>
      </div>
    )
  }

  {/* References Section */}
  {
    schema.allOf && schema.allOf.some((item: any) => item.$ref?.startsWith('https://')) && (
      <div>
        <h3 class="text-lg font-semibold mb-3">Inherits From</h3>
        <div class="border rounded-lg p-4">
          <ul class="space-y-2">
            {schema.allOf
              .filter((item: any) => item.$ref?.startsWith('https://'))
              .map((item: any) => (
                <li>
                  <a href={`${normalizedBase}schema/${getRefLink(item.$ref)}`} class="text-blue-600 hover:underline">
                    {item.$ref.split('/').slice(-2).join('/')}
                  </a>
                </li>
              ))}
          </ul>
        </div>
      </div>
    )
  }
</div>
